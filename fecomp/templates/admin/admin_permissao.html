{% extends 'admin/admin_base.html' %}

{% block title %}Gerir Utilizadores{% endblock %}

{% block content %}
<h2 class="page-title">Gerir administradores do sistema</h2>

<div class="user-list-container">
    {% for user in users %}
    <div class="user-manage-card">
        <div class="user-info">
            <strong>{{ user.name }}</strong>
            <span>{{ user.email }}</span>
        </div>
        
        <form class="user-role-form" action="{{ url_for('admin_bp.set_user_role', user_id=user.id) }}" method="POST">
            {{ form.hidden_tag() }}
            <label for="role-{{ user.id }}">Função:</label>
            <select name="role" id="role-{{ user.id }}">
                <option value="aluno" {% if user.role == 'aluno' %}selected{% endif %}>Aluno</option>
                <option value="professor" {% if user.role == 'professor' %}selected{% endif %}>Professor</option>
                <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Administrador</option>
            </select>
            <button type="submit" class="profile-btn">Salvar</button>
        </form>

        <div class="user-delete-action" style="margin-left: 10px;">
             <button class="profile-btn delete delete-user-btn" data-user-id="{{ user.id }}" data-user-name="{{ user.name }}">
                Excluir
            </button>
        </div>
        </div>
    {% else %}
    <div class="user-manage-card">
        <p>Nenhum outro utilizador registado no sistema.</p>
    </div>
    {% endfor %}
</div>

<div id="delete-user-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>Excluir Utilizador</h2>
        <p>Tem a certeza ABSOLUTA que deseja excluir <strong id="delete-user-name" style="color: var(--danger-color);"></strong>?</p>
        <p>Esta ação é irreversível. Todas as matérias pessoais, entregas, avisos e ficheiros deste utilizador serão permanentemente apagados.</p>
        <form id="delete-user-form" action="" method="post" style="margin-top: 20px;">
            {{ form.hidden_tag() }}
            <button type="submit" class="profile-btn delete">Sim, excluir este utilizador</button>
        </form>
    </div>
</div>
<style>
.user-list-container {
    width: 100%;
    max-width: 900px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.user-manage-card {
    background-color: var(--content-bg-color);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 5px var(--shadow-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap; /* Para ecrãs pequenos */
    gap: 15px;
}
.user-info {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
}
.user-info strong {
    font-size: 1.1em;
    font-weight: 600;
    color: var(--text-color);
}
.user-info span {
    font-size: 0.9em;
    color: var(--text-color-light);
}
.user-role-form {
    display: flex;
    align-items: center;
    gap: 10px;
}
.user-role-form label {
    font-weight: 600;
    color: var(--text-color);
}
.user-role-form select {
    padding: 8px;
    border: 1px solid var(--border-color);
    background-color: var(--bg-color);
    color: var(--text-color);
    border-radius: 8px;
    font-size: 0.9em;
}
.user-role-form .profile-btn {
    padding: 8px 15px;
    font-size: 0.9em;
    background-color: var(--success-color); /* Verde para salvar */
}
.user-role-form .profile-btn:hover {
    background-color: var(--success-hover-color);
}

/* Estilo do botão de excluir */
.user-delete-action .profile-btn.delete {
    padding: 8px 15px;
    font-size: 0.9em;
}

</style>

{% endblock %} 


{% block page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('delete-user-modal');
    if (!modal) return;

    const closeBtn = modal.querySelector('.close-btn');
    const deleteForm = modal.querySelector('#delete-user-form');
    const userNameEl = modal.querySelector('#delete-user-name');

    document.querySelectorAll('.delete-user-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const userId = btn.dataset.userId;
            const userName = btn.dataset.userName;
            
            // Configura o formulário do modal
            deleteForm.action = `{{ url_for('admin_bp.index') }}user/${userId}/delete`;
            userNameEl.textContent = userName;
            
            // Abre o modal
            modal.classList.add('active');
        });
    });

    // Fecha o modal
    closeBtn.addEventListener('click', () => {
        modal.classList.remove('active');
    });

    window.addEventListener('click', (event) => {
        if (event.target == modal) {
            modal.classList.remove('active');
        }
    });
});
</script>
{% endblock %}