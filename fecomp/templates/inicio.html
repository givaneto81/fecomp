{% extends 'base.html' %}

{% block title %}In√≠cio{% endblock %}

{% block content %}
<h2 class="page-title">Ol√°, {{ session['user_name'] }}!</h2>

<div class="grid-inicio">
    <div class="cartao-boasvindas">
        <h3>üéØ Dica do Dia</h3>
        <p id="texto-dica">Carregando...</p>

        <button class="btn-ia" onclick="window.location.href='{{ url_for('visoes.pagina_chat') }}'">
            <i data-feather="message-circle"></i>
            <span>Tirar d√∫vida com a IA</span>
        </button>
    </div>

    <div class="cartao-atalho" role="button" tabindex="0" aria-label="Abrir Minhas Mat√©rias" onclick="window.location.href='{{ url_for('visoes.pagina_materias') }}'">
        <i data-feather="book-open"></i>
        <h4>Minhas Mat√©rias</h4>
        <p>Aceda e organize os seus materiais de estudo.</p>
    </div>
</div>

{% if featured_subjects %}
<div class="mural-avisos-container">
    <h3 class="page-title" style="font-size: 1.5em; margin-bottom: 15px;">
        <i data-feather="star" style="width: 20px; height: 20px; vertical-align: text-bottom; color: #f0ad4e;"></i>
        Conte√∫do em Destaque (SSA/ENEM)
    </h3>
    <div class="subject-grid" style="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));">
        {% for subject in featured_subjects %}
        <div class="subject-card contrast-card" style="background-color: {{ subject.color }}; min-height: 100px;">
            <a href="{{ url_for('visoes.pastas_page', subject_id=subject.id) }}" class="subject-link">
                <span>{{ subject.name }}</span>
                {% if subject.course %}
                <small style="font-weight: 400; margin-top: 5px;">(Turma: {{ subject.course.name }})</small>
                {% endif %}
            </a>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% if has_courses %}

    {% if announcements %}
    <div class="mural-avisos-container">
        <h3 class="page-title" style="font-size: 1.5em; margin-bottom: 15px;">
            <i data-feather="bell" style="width: 20px; height: 20px; vertical-align: text-bottom;"></i>
            Mural de Avisos
        </h3>
        {% for aviso in announcements %}
        <div class="aviso-card">
            <p class="aviso-content">{{ aviso.content }}</p>
            <small class="aviso-meta">
                Postado em: {{ aviso.timestamp.strftime('%d/%m/%Y √†s %H:%M') }}<br>
                Por: <strong>{{ aviso.professor.name }}</strong> (Turma: {{ aviso.course.name }})
            </small>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if session.get('user_role') == 'aluno' and pending_tasks %}
        <div class="mural-avisos-container">
            <h3 class="page-title" style="font-size: 1.5em; margin-bottom: 15px;">
                <i data-feather="check-square" style="width: 20px; height: 20px; vertical-align: text-bottom;"></i>
                Tarefas Pendentes
            </h3>
            {% for task in pending_tasks %}
            <div class="aviso-card" style="border-left-color: #f0ad4e;">
                <p class="aviso-content"><strong>{{ task.title }}</strong> (Turma: {{ task.course.name }})</p>
                <small class="aviso-meta">
                    Prazo: {{ task.due_date.strftime('%d/%m/%Y √†s %H:%M') if task.due_date else 'Sem prazo' }}<br>
                    <a href="{{ url_for('visoes.tasks') }}" style="color: var(--primary-color); font-weight: 600;">Ir para tarefas</a>
                </small>
            </div>
            {% endfor %}
        </div>
    {% endif %}

{% else %}

    <div class="mural-avisos-container">
        <div class="aviso-card" style="border-left-color: var(--success-color);">
            <h3 style="margin-top: 0; color: var(--success-color);">Onboarding</h3>

            {% if session.get('user_role') == 'aluno' %}
                <p class="aviso-content">
                    Ol√°! Parece que voc√™ ainda n√£o est√° em nenhuma turma. Pe√ßa ao seu administrador para adicion√°-lo(a) para come√ßar a ver tarefas e avisos.
                    <br><br>
                    Enquanto isso, sinta-se √† vontade para usar suas <a href="{{ url_for('visoes.pagina_materias') }}" style="color: var(--primary-color); font-weight: 600;">Mat√©rias Pessoais</a> para organizar seus estudos!
                </p>
            {% else %} <p class="aviso-content">
                    Ol√°, Professor(a)! Voc√™ ainda n√£o foi associado(a) a nenhuma turma.
                    <br><br>
                    Por favor, entre em contato com o Administrador do sistema para que ele possa vincular voc√™ √†s suas turmas. Feito isso, voc√™ poder√° postar tarefas e avisos usando o link <strong>Admin</strong> na barra lateral.
                </p>
            {% endif %}
        </div>
    </div>

{% endif %}

<div class="subject-grid">
    </div>

{% endblock %}

{% block page_scripts %}
<script>
    fetch('/api/dica_do_dia')
        .then(response => response.json())
        .then(data => {
            const elementoDica = document.getElementById('texto-dica');
            if (data.dica) {
                elementoDica.textContent = data.dica;
            } else {
                elementoDica.textContent = 'N√£o foi poss√≠vel carregar a dica de hoje. Estude bastante!';
            }
        })
        .catch(error => {
            console.error('Erro ao buscar dica:', error);
            document.getElementById('texto-dica').textContent = 'Tente novamente mais tarde para ver a dica de hoje.';
        });

    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('[role="button"]').forEach(function(el) {
            el.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    el.click();
                }
            });
        });
    });
</script>
{% endblock %}