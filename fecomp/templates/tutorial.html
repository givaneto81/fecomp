<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bem-vindo ao Educa AI</title>
    <link rel="icon" href="{{ url_for('static', filename='imagens/logo.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
</head>
<body class="tutorial-page">

    <div class="tutorial-container">
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}" style="font-size: 0.9em; padding: 8px;">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="tutorial-slider">

            {% if user_role == 'aluno' %}
            <div class="tutorial-etapa" id="etapa-1">
                <h2>ðŸŽ“ Bem-vindo(a) ao Educa AI!</h2>
                <p>O seu novo assistente de estudos para o SSA e ENEM. Vamos configurar seu perfil rapidamente.</p>
            </div>
            
            <div class="tutorial-etapa" id="etapa-2">
                <h2>ðŸ“¸ Configure seu Perfil</h2>
                <p>Que tal uma foto de perfil? (Ou pode pular clicando em "PrÃ³ximo")</p>
                <img src="{{ url_for('static', filename='avatars/' + user.profile_pic) }}" 
                     alt="Foto de Perfil" 
                     class="profile-pic-tutorial"
                     onerror="this.src='{{ url_for('static', filename='avatars/default_avatar.png') }}';">
                
                <form action="{{ url_for('visoes.upload_avatar') }}" method="post" enctype="multipart/form-data" class="tutorial-upload-form">
                    <input type="file" name="avatar" accept="image/png, image/jpeg, image/gif" required>
                    <button type="submit" class="btn-tutorial-upload">Enviar Foto</button>
                </form>
            </div>
            
            <div class="tutorial-etapa" id="etapa-3">
                <h2>ðŸ“˜ Organize-se como nunca</h2>
                <p>Crie <strong>MatÃ©rias</strong> (como "MatemÃ¡tica"), dentro delas crie <strong>Pastas</strong> (como "Provas Antigas") e envie os seus <strong>Ficheiros</strong> (PDFs, imagens, etc.).</p>
            </div>
            
            <div class="tutorial-etapa" id="etapa-4">
                <h2>ðŸ’¬ Tire dÃºvidas a qualquer hora</h2>
                <p>Use o nosso <strong>Chat IA</strong> para explicar tÃ³picos, resolver problemas e obter resumos. Ã‰ como ter um professor particular 24 horas por dia!</p>
            </div>
            
            {% else %} <div class="tutorial-etapa" id="etapa-1-prof">
                <h2>ðŸŽ“ Bem-vindo(a), Professor(a)!</h2>
                <p>VocÃª estÃ¡ no Educa AI. Vamos configurar seu perfil rapidamente.</p>
            </div>
            
            <div class="tutorial-etapa" id="etapa-2-prof">
                <h2>ðŸ“¸ Configure seu Perfil</h2>
                <p>Uma foto de perfil ajuda os alunos a identificarem vocÃª. (Ou pode pular clicando em "PrÃ³ximo")</p>
                <img src="{{ url_for('static', filename='avatars/' + user.profile_pic) }}" 
                     alt="Foto de Perfil" 
                     class="profile-pic-tutorial"
                     onerror="this.src='{{ url_for('static', filename='avatars/default_avatar.png') }}';">
                
                <form action="{{ url_for('visoes.upload_avatar') }}" method="post" enctype="multipart/form-data" class="tutorial-upload-form">
                    <input type="file" name="avatar" accept="image/png, image/jpeg, image/gif" required>
                    <button type="submit" class="btn-tutorial-upload">Enviar Foto</button>
                </form>
            </div>
            
            <div class="tutorial-etapa" id="etapa-3-prof">
                <h2>ðŸš€ GestÃ£o Completa</h2>
                <p>No painel <strong>Admin</strong>, vocÃª poderÃ¡ criar <strong>Tarefas</strong>, postar <strong>Avisos</strong> no mural dos alunos e adicionar <strong>MatÃ©rias</strong> Ã  sua turma (assim que for vinculado a uma).</p>
            </div>
            
            <div class="tutorial-etapa" id="etapa-4-prof">
                <h2>ðŸ“‚ Use-o como repositÃ³rio</h2>
                <p>VocÃª tambÃ©m pode usar a secÃ§Ã£o <strong>MatÃ©rias</strong> como seu repositÃ³rio pessoal de arquivos, separado das turmas. Comece a se organizar!</p>
            </div>
            {% endif %}
        </div>

        <div class="tutorial-nav">
            <button id="btn-anterior" class="btn-tutorial" style="visibility: hidden;">Anterior</button>
            <div class="etapa-indicadores">
                <span class="active"></span><span></span><span></span><span></span>
            </div>
            <button id="btn-proximo" class="btn-tutorial">PrÃ³ximo</button>
            <button id="btn-comecar" class="btn-tutorial" style="display: none;">ComeÃ§ar!</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const slider = document.querySelector('.tutorial-slider');
            const btnAnterior = document.getElementById('btn-anterior');
            const btnProximo = document.getElementById('btn-proximo');
            const btnComecar = document.getElementById('btn-comecar');
            const indicadores = document.querySelectorAll('.etapa-indicadores span');
            
            let etapaAtual = 0;
            // --- MUDANÃ‡A AQUI, GIVA ---
            const totalEtapas = 4; // AGORA SÃƒO 4 ETAPAS

            function atualizarInterface() {
                slider.style.transform = `translateX(-${etapaAtual * 100}%)`;
                
                btnAnterior.style.visibility = etapaAtual === 0 ? 'hidden' : 'visible';
                btnProximo.style.display = etapaAtual === totalEtapas - 1 ? 'none' : 'block';
                btnComecar.style.display = etapaAtual === totalEtapas - 1 ? 'block' : 'none';

                indicadores.forEach((indicador, index) => {
                    indicador.classList.toggle('active', index === etapaAtual);
                });
            }

            btnProximo.addEventListener('click', () => {
                if (etapaAtual < totalEtapas - 1) {
                    etapaAtual++;
                    atualizarInterface();
                }
            });

            btnAnterior.addEventListener('click', () => {
                if (etapaAtual > 0) {
                    etapaAtual--;
                    atualizarInterface();
                }
            });

            btnComecar.addEventListener('click', async () => {
                btnComecar.disabled = true;
                btnComecar.textContent = 'Aguarde...';

                try {
                    const response = await fetch('/api/utilizador/concluir_tutorial', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Falha ao guardar o progresso.');
                    }
                    
                    btnComecar.textContent = 'ConcluÃ­do!';
                    window.location.href = "{{ url_for('visoes.pagina_inicio') }}";

                } catch (error) {
                    console.error('Erro:', error);
                    alert('Ocorreu um erro. Por favor, tente novamente.');
                    btnComecar.disabled = false;
                    btnComecar.textContent = 'ComeÃ§ar!';
                }
            });
        });
    </script>
</body>
</html>